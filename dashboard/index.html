<!DOCTYPE html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="/static/classmate_logo.png">

    <!-- Bootstrap -->
    <link href="/static/bootstrap.css" rel="stylesheet">
    <script src="/static/bootstrap.js"></script>

    <!-- ChartJS -->
    <script src="/static/chart.js"></script>


    <title>ClassMate Dashboard</title>
</head>
<body>

    <div class="container">
        <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center col-md-3 mb-2 mb-md-0 text-dark text-decoration-none">
                <img src="/static/classmate_logo.png" class="bi me-2" width="40" height="32" />
                <span class="fs-4">ClassMate</span>
            </a>
    
            <ul class="nav col-12 col-md-auto mb-2 justify-content-center mb-md-0">
                <li>
                    <a class="nav-link px-2">
                        <span id="statusPrefix" class="text-dark">Status:</span>
                        <span id="status" class="text-danger">Disconnected</span>
                    </a>
                </li>
            </ul>
        
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-outline-dark me-2" onClick="window.location.reload();">Refresh page</button>
                <a type="button" class="btn btn-dark" href="https://github.com/nargesn4/classmate" target="_blank">Source code</a>
            </div>
        </header>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8">
                Plek voor grafieken
                <div class="row">
                    <div class="col-6">
                        <canvas id="2H" width="400" height="400"></canvas>
                    </div>
                    <div class="col-6">
                        <canvas id="24H" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="">
                    <h4>Current State</h4>
                    <ol class="list-group list-group-numbered">
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Temperature inside</div>
                            The temperature inside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_temperature_inside"></span>°C
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Humidity inside</div>
                            The humidity inside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_humidity_inside"></span>%
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Temperature outside</div>
                            The temperature outside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_temperature_outside"></span>°C
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Humidity outside</div>
                            The humidity outside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_humidity_outside"></span>%
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">CO2</div>
                            The CO2 levels inside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                              <span id="visualize_co2"></span> ppm
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">CO</div>
                            The CO levels inside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_co"></span> ppm
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Smoke</div>
                            The smoke levels inside the classroom
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_smoke"></span> ppm
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Noisy outside</div>
                            Is it noisy outside?
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_noisy_outside"></span> 
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Door open</div>
                            Is the door open?
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_door_open"></span> 
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Do not disturb</div>
                            Is the do not disturb mode activated?
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_do_not_disturb"></span> 
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Busy in 15 minutes</div>
                            Will the room be used in 15 minutes?
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_busy_in_15_minutes"></span> 
                          </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-start py-0">
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">Favorable conditions</div>
                            Is the room in a favorable condition now?
                          </div>
                          <span class="badge bg-primary rounded-pill">
                            <span id="visualize_favorable_conditions"></span> 
                          </span>
                        </li>
                      </ol>
                </div>
                <h4 class="mt-5">Console</h4>
                <div class="py-2">
                    <form class="row g-3" id="messageForm">
                        <div class="col-12">
                            <input type="text" class="form-control" id="message" placeholder="Message: ">
                        </div>
                        <div class="col-8">
                            <input type="text" class="form-control" id="action_type" placeholder="Action: ACTION_CHAT / ACTION_RICKROLL / ...">
                        </div>
                        <div class="col-4">
                            <button type="submit" class="btn btn-primary btn-block w-100">Send</button>
                        </div>
                    </form>
                    <div id="messages" class="mt-3 bg-light" style="min-height: 100px; max-height: 500px; overflow-y: scroll; font-size: 9px;"></div>
                </div>
            </div>
        </div>
    </div>


    <script>


        var data_size = 7;
        const labels = ['0', '1', '2', '3', '4', '5', '6'];
        const data = {
          labels: labels,
          datasets: [
            {
                label: 'Temperature Inside',
                data: [20, 21, 21, 24, 25, 23, 22],
                borderColor: "#F00",
                backgroundColor: "#F00",
                cubicInterpolationMode: 'monotone',
                tension: 0.4
            },
            {
              label: 'Temperature Outside',
              data: [20, 20, 21, 20, 21, 21, 20],
              borderColor: "#A00",
              backgroundColor: "#F55",
              cubicInterpolationMode: 'monotone',
              tension: 0.4
            },
            {
                label: 'Humidity Inside',
                data: [20, 21, 21, 24, 25, 23, 22],
                borderColor: "#00F",
                backgroundColor: "#00F",
                cubicInterpolationMode: 'monotone',
                tension: 0.4,
                yAxisID: 'y1'
            },
            {
              label: 'Humidity Outside',
              data: [20, 20, 21, 20, 21, 21, 20],
              borderColor: "#00A",
              backgroundColor: "#55F",
              cubicInterpolationMode: 'monotone',
              tension: 0.4,
              yAxisID: 'y1'
            },
            {
                label: 'CO2 (ppm)',
                data: [20, 21, 21, 24, 25, 23, 22],
                borderColor: "#0F0",
                backgroundColor: "#0A0",
                cubicInterpolationMode: 'monotone',
                tension: 0.4,
                yAxisID: 'y2'
            },
            {
                label: 'CO (ppm)',
                data: [20, 21, 21, 24, 25, 23, 22],
                borderColor: "#0F0",
                backgroundColor: "#0A0",
                cubicInterpolationMode: 'monotone',
                tension: 0.4,
                yAxisID: 'y3'
            },
            {
                label: 'Smoke (ppm)',
                data: [20, 21, 21, 24, 25, 23, 22],
                borderColor: "#00F",
                backgroundColor: "#00A",
                cubicInterpolationMode: 'monotone',
                tension: 0.4,
                yAxisID: 'y3'
            },
            {
              label: 'Door Open',
              data: ['YES', 'YES', 'NO', 'YES', 'NO', 'NO'],
              borderColor: "#F00",
              backgroundColor: "#F00",
              //stepped: true,
              yAxisID: 'y4'
            },
            {
              label: 'Noisy Outside',
              data: ['YES', 'NO', 'NO', 'YES', 'YES', 'NO'],
              borderColor: "#0F0",
              backgroundColor: "#0F0",
              //stepped: true,
              yAxisID: 'y4'
            },
            {
              label: 'Do Not Disturb Active',
              data: ['YES', 'YES', 'NO', 'NO', 'YES', 'NO'],
              borderColor: "#00F",
              backgroundColor: "#00F",
              //stepped: true,
              yAxisID: 'y4'
            }
          ]
        };

        const ctx = document.getElementById('2H').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                plugins: {
                    title: {
                    display: true,
                    text: 'Stacked scales',
                    },
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        stack: 'demo',
                        stackWeight: 2,
                        grid: {
                            borderColor: "#F00"
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'left',
                        stack: 'demo',
                        stackWeight: 2,
                        grid: {
                            borderColor: "#00F"
                        }
                    },
                    y2: {
                        type: 'linear',
                        position: 'left',
                        stack: 'demo',
                        stackWeight: 2,
                        grid: {
                            borderColor: "#0F0"
                        }
                    },
                    y3: {
                        type: 'linear',
                        position: 'left',
                        stack: 'demo',
                        stackWeight: 2,
                        grid: {
                            borderColor: "#0F0"
                        }
                    },
                    y4: {
                        type: 'category',
                        labels: ['YES', 'NO'],
                        offset: true,
                        position: 'left',
                        stack: 'demo',
                        stackWeight: 1,
                        grid: {
                            borderColor: "#00F"
                        }
                    }
                }
            },
        });

        const StatusDisconnected = Symbol("Disconnected")
        const StatusConnecting = Symbol("Connecting")
        const StatusReconnecting = Symbol("Reconnecting")
        const StatusConnected = Symbol("Connected")

        changeStatus(StatusDisconnected);

        function changeStatus(s) {
            const statusElement = document.getElementById("status");
            if (s == StatusDisconnected) {
                statusElement.innerHTML = "Disconnected";
                statusElement.className = "text-danger";
            }
            else if (s == StatusConnecting) {
                statusElement.innerHTML = "Connecting...";
                statusElement.className = "text-warning";
            }
            else if (s == StatusReconnecting) {
                statusElement.innerHTML = "Reconnecting...";
                statusElement.className = "text-warning";
            }
            else if (s == StatusConnected) {
                statusElement.innerHTML = "Connected";
                statusElement.className = "text-success";
            }
            else {
                statusElement.innerHTML = "Unknown";
                statusElement.className = "text-secondary";
            }
        }

        var username = "Dashboard";
        var ws;

        function connect() {
            ws = new WebSocket("ws://" + window.location.host + "/websocket");
            var keepAlive = true;

            changeStatus(StatusConnecting);

            ws.onopen = function() {
                changeStatus(StatusConnected);
                var form = document.getElementById("messageForm");
                if(form.addEventListener)
                    form.addEventListener("submit", listenerFunction, false)
            };
            
            ws.onmessage = function(e) {
                changeStatus(StatusConnected);
                //try {
                    var msg = JSON.parse(e.data);
                    if (msg.action == "ACTION_ALIVE")
                        return;
                    else if (msg.action == "ACTION_CHAT")
                        printMessage(msg.client_id + ' ' + msg.action + ' | ' + msg.data.user + ": " + msg.data.message)
                    else if (msg.action == "ACTION_STATUS_UPDATE") {
                        // printMessage(msg.client_id + ' ' + msg.action)
                        // console.log(msg.data);
                        for(const [key, value] of Object.entries(msg.data)) {
                            var visualizationHtml = document.getElementById(`visualize_${key}`);
                            if(visualizationHtml != null) {
                                kv = keyValueToChartIndexValue(key, value)
                                if (kv != null) {
                                    visualizationHtml.innerHTML = kv.value;
                                }
                            }
                        }
                    }
                    else if (msg.action == "ACTION_STATUS_HISTORY") {
                        if (msg.data.length < myChart.data.labels.length) {
                            myChart.data.labels = [];
                            for(const [index, value] of Object.entries(myChart.data.datasets)) {
                                console.log(index);
                                myChart.data.datasets[index].data = [];
                            }
                        }
                        console.log(msg.data.length);
                        shouldChartUpdate = atLeastOneRecordAdded = false;
                        for(const [index, keyValue] of Object.entries(msg.data)) {
                            for(const [key, value] of Object.entries(keyValue)) {
                                kv = keyValueToChartIndexValue(key, value)
                                if (kv != null && kv.key != null) {
                                    myChart.data.datasets[kv.key].data[index] = kv.value;
                                    shouldChartUpdate = atLeastOneRecordAdded = true;
                                }
                            }
                            if (shouldChartUpdate) {
                                myChart.data.labels[index] = index;
                            }
                        }
                        if (shouldChartUpdate) {
                            myChart.update();
                        }

                        /*myChart.data.labels[data_size] = data_size;
                        myChart.data.datasets[0].data[data_size] = 15;
                        myChart.data.datasets[1].data[data_size] = 15;
                        myChart.data.datasets[2].data[data_size] = 'CLOSED';
                        console.log(myChart.data.datasets[0].data);
                        console.log(myChart.data.datasets[1].data);
                        console.log(myChart.data.datasets[2].data);
                        data_size++;
                        console.log(data_size);
                        myChart.update();*/
                    }
                    else if (!msg.client_id == "CLIENT_ID_ESP_TEMPERATURE_HUMIDITY")
                        printMessage(msg.client_id + ' ' + msg.action)
                    //else
                    //    printMessage(messageDict.client_id + ' ' + messageDict.action)
                //}
                /*catch (e) {
                    console.log(e);
                    printMessage("Unknown Error, a message was received but we were unable to read it.");
                }*/
            };
        
            ws.onclose = function(e) {
                changeStatus(StatusDisconnected);
                keepAlive = false;
                console.log('Socket is closed. Reconnect will be attempted in 5 seconds.', e.reason);
                changeStatus(StatusReconnecting)
                
                var form = document.getElementById("messageForm");
                form.removeEventListener("submit", listenerFunction)

                // This makes the script execute stuff multiple times.
                setTimeout(() => {
                    connect()
                }, 5000);
                delete ws;
            };
        
            ws.onerror = function(err) {
                changeStatus(StatusDisconnected);
                console.error('Socket encountered error: ', 'Closing socket');
                ws.close();
            };

            //keepConnectionAlive();
        }

        // key: string
        function keyValueToChartIndexValue(k, v) {
            if (k == "temperature_inside")
                return { key: 0, value: v };
            else if (k == "temperature_outside")
                return { key: 1, value: v };
            if (k == "humidity_inside")
                return { key: 2, value: v };
            else if (k == "humidity_outside")
                return { key: 3, value: v };
            else if (k == "co2")
                return { key: 4, value: v };
            else if (k == "co") {
                console.log("CO");
                console.log(v);
                return { key: 5, value: Math.round(v * 100000) / 100000000 };
            }
            else if (k == "smoke") {
                console.log("SMOKE");
                console.log(v);
                return { key: 6, value: Math.round(v * 100000) / 100000000 };
            }
            else if (k == "door_open")
                return { key: 7, value: v ? "YES" : "NO" };
            else if (k == "noisy_outside")
                return { key: 8, value: v ? "YES" : "NO" };
            else if (k == "do_not_disturb")
                return { key: 9, value: v ? "YES" : "NO" };
            else if (k == "busy_in_15_minutes")
                return { key: null, value: v ? "YES" : "NO" };
            else if (k == "favorable_conditions")
                return { key: null, value: v ? "YES" : "NO" };
            else
                return null;
        }

        function listenerFunction(e) {
            e.preventDefault();    //stop form from submitting
            sendMessage()
        }

        function sendMessage() {    
            var actionTypeInput = document.getElementById("action_type");
            var messageInput = document.getElementById("message");
            var actionType = actionTypeInput.value;
            var message = messageInput.value;
            if(actionType == "ACTION_CHAT")
                wsMessage("ACTION_CHAT", {
                    "user": username,
                    "message": message
                })
            else
                wsMessage(actionType, message)
                
            // Clear the message from the input.
            actionTypeInput.value = "ACTION_CHAT";
            messageInput.value = "";
            return false;
        }

        function wsMessage(action, data) {
            // Make the request to the WebSocket.
            ws.send(JSON.stringify({
                "client_id": "CLIENT_ID_DASHBOARD",
                "action": action,
                "data": data
            }));
        }

        function printMessage(message) {
            var messageBox = document.createElement("div");
            messageBox.innerHTML = message;
            document.getElementById("messages").prepend(messageBox);
        }

        async function keepConnectionAlive() {
            while (true) {
                await new Promise(r => setTimeout(r, 10000));
                wsMessage("ACTION_ALIVE", {
                    "user": username,
                    "message": "Keeping connection alive."
                })
            }
        }
        
        connect();
            
        keepConnectionAlive();
    </script>
</body>
</html>